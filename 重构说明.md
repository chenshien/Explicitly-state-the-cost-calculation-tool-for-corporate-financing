# 企业融资成本计算工具重构说明

## 重构背景
根据info.pdf文档（《企业贷款综合融资成本年化率的计算规则及示例》），对原有的计算方法进行了全面重构，以符合人民银行最新的计算规则要求。

## 主要改动

### 1. 计算方法改进
- **原方法**：使用预设的调整因子表和还款方式调整系数
- **新方法**：采用内部收益率法（IRR）精确计算每项费用的年化率

### 2. 核心算法实现
实现了基于现金流折现的IRR计算方法：
```
A = Σ Pjt / [(1+R)^st × (1+R×ft)]
```
通过求解此方程得到单位周期费率R，再转换为年化率。

### 3. 新增功能
- 支持"银行承担"费用的标记
- 银行承担的费用不计入企业融资成本（年化率为0）
- 在界面和导出报表中明确标示银行承担的费用

### 4. 技术改进
- 引入scipy库用于数值求解
- 改进了等额本息还款的本金分期计算
- 提高了计算精度和准确性

### 5. 文件变更

#### calculator.py
- 删除了调整因子表相关代码
- 实现了`calculate_fee_annual_rate_irr`方法
- 新增了`_calculate_one_time_fee_rate`和`_calculate_periodic_fee_rate`方法
- 改进了`_get_payment_schedule`方法

#### main.py
- 费用项增加了"银行承担"复选框
- 计算结果显示中标记银行承担的费用
- 导出功能更新为使用新的IRR计算方法

#### requirements.txt
- 新增scipy>=1.7.0依赖

#### README.md
- 更新了计算方法说明
- 增加了版本更新日志
- 完善了使用说明

## 测试验证
通过info.pdf中的多个计算示例进行了验证：
- 例3（等额本金，期初一次性费用）：误差0%
- 例5（等额本息，期初一次性费用）：误差<0.001%
- 例9（等额本金，周期性费用）：计算正确

测试案例（300万元，18个月，评估费6200元）：
- 官方工具：4.1582%
- 精确模式：4.1719%（差异0.0137%）
- 整数模式：4.1614%（差异0.0032%）

## 注意事项
1. 新方法计算可能比原方法稍慢，因为需要数值求解
2. 对于某些极端情况，如果IRR求解失败，会退回到简化计算
3. 历史记录的费用年化率在导出时会使用新方法重新计算

## 版本信息
- 原版本：V1.1
- 新版本：V1.2
- 更新日期：2024年

## 后续优化（V1.2.1）

### 计算精度改进
经过与官方工具的对比测试，发现计算差异主要源于期数计算方法：
- **原实现**：精确计算日期间隔的小数期数（如0.6333个月）
- **官方工具**：使用整数期数（1, 2, 3...）

### 解决方案
在`FinanceCostCalculator`类中增加了`calculation_mode`参数：
- `"precise"`：精确模式，考虑日期偏移的小数期数
- `"integer"`：整数模式，使用标准整数期数（默认）

### 改进效果
使用整数模式后，计算结果与官方工具的差异从0.0137%降低到0.0032%，大幅提高了计算准确性。

测试案例（300万元，18个月，评估费6200元）：
- 官方工具：4.1582%
- 精确模式：4.1719%（差异0.0137%）
- 整数模式：4.1614%（差异0.0032%）

## 进一步优化（V1.2.2）

### 智能计算模式
经过更多测试案例的分析，发现官方工具的计算规则：
- **同月还款**（起始日和首次还款日在同一个月）：使用整数期数
- **跨月还款**（起始日和首次还款日不在同一个月）：使用精确期数

### 解决方案
增加了`"auto"`计算模式（现为默认模式）：
- 自动判断首次还款日是否在同一个月
- 智能选择使用整数期数或精确期数
- 无需用户手动选择计算模式

### 测试验证
两个测试案例的结果：

**案例1**（同月还款，5月1日→5月20日）：
- 官方工具：4.1582%
- auto模式：4.1614%（差异0.0032%）

**案例2**（跨月还款，5月1日→6月20日）：
- 官方工具：4.5666%
- auto模式：4.5665%（差异0.0001%）

### 关于周期费率
官方工具显示的周期费率（如0.0055%）可能存在显示问题，与年化率不一致。我们的程序使用标准公式计算：周期费率 = 年化率 × 期限 / 12

## 概念澄清（V1.2.3）

### 周期费率的定义差异
经过深入分析，发现官方工具和我们程序对"周期费率"的定义不同：

**官方工具的"周期费率"**：
- 实际上是**月费率**
- 计算公式：周期费率 = 年化率 / 12
- 例如：年化率0.0065% → 周期费率0.0005%

**我们程序的"周期费率"**：
- 是整个贷款期间的**总费率**
- 计算公式：周期费率 = 年化率 × 期限年数
- 例如：年化率0.0065%，期限3年 → 周期费率0.0195%

### 解决方案
为避免混淆，程序界面已更新：
- 将原"周期费率"改为"期间总费率"
- 新增"月费率"列，与官方工具的"周期费率"对应
- 同时显示两个指标，用户可根据需要选择使用

### 验证示例
1200万元贷款，36个月期限，评估费1200元：
- 年化率：0.0065%
- 月费率：0.0005%（= 0.0065% / 12，对应官方"周期费率"）
- 期间总费率：0.0195%（= 0.0065% × 3年） 